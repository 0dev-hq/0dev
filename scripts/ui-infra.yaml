AWSTemplateFormatVersion: '2010-09-09'
Description: CloudFormation template to create a single S3 bucket for ui.0dev.io with static hosting

Parameters:
  DomainName:
    Description: The domain name for the bucket (e.g., ui.0dev.io)
    Type: String
    Default: "ui.0dev.io"

Resources:
  UIDomainBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref DomainName
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: index.html
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false
    DeletionPolicy: Retain

  UIDomainBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref UIDomainBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          # Deny all access from non-Cloudflare IPs
          - Sid: "AllowCloudflareIPs"
            Effect: Deny
            Principal: "*"
            Action: "s3:GetObject"
            Resource: !Sub "arn:aws:s3:::${DomainName}/*"
            Condition:
              NotIpAddress:
                aws:SourceIp:
                  - 173.245.48.0/20
                  - 103.21.244.0/22
                  - 103.22.200.0/22
                  - 103.31.4.0/22
                  - 141.101.64.0/18
                  - 108.162.192.0/18
                  - 190.93.240.0/20
                  - 188.114.96.0/20
                  - 197.234.240.0/22
                  - 198.41.128.0/17
                  - 162.158.0.0/15
                  - 104.16.0.0/13
                  - 104.24.0.0/14
                  - 172.64.0.0/13
                  - 131.0.72.0/22
                  - 2400:cb00::/32
                  - 2606:4700::/32
                  - 2803:f800::/32
                  - 2405:b500::/32
                  - 2405:8100::/32
                  - 2a06:98c0::/29
                  - 2c0f:f248::/32

          # Allow public read access to the bucket
          - Sid: "PublicReadGetObjectAllow"
            Effect: Allow
            Principal: "*"
            Action: "s3:GetObject"
            Resource: !Sub "arn:aws:s3:::${DomainName}/*"

Outputs:
  UIDomainBucketWebsiteURL:
    Description: The website URL for the S3 bucket (ui.0dev.io)
    Value: !GetAtt UIDomainBucket.WebsiteURL
